<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gesture Control - Ultrasonic Sensors</title>

  <style>
    :root{
      --bg:#0f172a; --card:#111827; --accent:#22c55e; --text:#e5e7eb;
      --muted:#94a3b8; --border:#1f2937; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:32px;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background: radial-gradient(circle at top,#020617,var(--bg));color:var(--text);
    }
    .topbar{display:flex;align-items:baseline;justify-content:space-between;gap:16px;max-width:1100px}
    h1{margin:0 0 8px 0;font-size:28px;font-weight:800;letter-spacing:-.5px}
    .subtitle{color:var(--muted);margin-bottom:18px;max-width:820px}
    .rightinfo{text-align:right;color:var(--muted);font-size:13px;line-height:1.35;min-width:220px}
    .status{display:inline-flex;align-items:center;gap:10px;margin:10px 0 18px 0;font-size:14px;color:var(--muted);max-width:1100px}
    .dot{width:10px;height:10px;border-radius:50%;background:#ef4444}
    .dot.connected{background:var(--accent);box-shadow:0 0 10px rgba(34,197,94,.6)}
    .dot.warn{background:var(--warn);box-shadow:0 0 10px rgba(245,158,11,.35)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;max-width:1100px;}
    .card{background: linear-gradient(180deg,#020617,var(--card));border:1px solid var(--border);border-radius:18px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.4);
    }
    .label{font-size:14px;color:var(--muted);margin-bottom:6px;letter-spacing:.3px}
    .value{display:flex;align-items:baseline;gap:8px;font-size:56px;font-weight:900;letter-spacing:-1px}
    .unit{font-size:20px;color:var(--muted)}
    .meta{margin-top:6px;font-size:12px;color:var(--muted)}
    .big{font-size:34px;font-weight:900;letter-spacing:-.5px;line-height:1.1;display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border); background:#0b1220;color:var(--muted); font-size:13px;
    }
    .log{margin-top:20px;max-width:1100px;background:#020617;border:1px solid var(--border);border-radius:16px;padding:16px;height:180px;overflow-y:auto;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:13px;color:#cbd5f5;white-space:pre-wrap;
    }
    footer{margin-top:18px;font-size:13px;color:var(--muted);max-width:1100px}
    .bottom-row {display: grid;grid-template-columns: 1fr 1fr; /* 50% / 50% */gap: 20px;margin-top: 20px;max-width: 1100px;
    }
    .sonar-container {display: flex;justify-content: center;align-items: center;background: #020617;border: 1px solid #1f2937;border-radius: 16px;padding: 20px;
    }
    #sonar {width: 100%;max-width: 450px;border-radius: 12px;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1>Gesture Control – Ultrasonic Sensors</h1>
      <div class="subtitle">
        Live data from two ultrasonic sensors + detected gesture (MQTT → WebSocket).
      </div>
    </div>

    <div class="rightinfo">
      <div><b>Local time</b></div>
      <div id="clock">—</div>
      <div style="margin-top:6px;"><b>Last MQTT msg</b></div>
      <div id="lastMsgTime">—</div>
    </div>
  </div>

  <div class="status">
    <div id="dot" class="dot"></div>
    <div>
      <div><span id="status">disconnected</span></div>
      <div style="font-size:12px;margin-top:2px;color:var(--muted)">
        Broker: <span id="brokerLabel">—</span>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="label">Left Sensor</div>
      <div class="value"><span id="dL">—</span><span class="unit">cm</span></div>
      <div class="meta">Last update: <span id="tL">—</span></div>
    </div>

    <div class="card">
      <div class="label">Right Sensor</div>
      <div class="value"><span id="dR">—</span><span class="unit">cm</span></div>
      <div class="meta">Last update: <span id="tR">—</span></div>
    </div>

    <div class="card">
      <div class="label">Last Gesture</div>
      <div class="big" id="gestureText">—</div>
      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <span class="pill">Triggered first: <b id="startSensor">—</b></span>
        <span class="pill">Total gestures: <b id="gestureCount">0</b></span>
      </div>
      <div class="meta">Last gesture time: <span id="gestureTime">—</span></div>
    </div>
  </div>

  <div class="bottom-row">
  <div class="log" id="log">
    Waiting for MQTT messages…
  </div>
  <div class="sonar-container">
    <canvas id="sonar" width="520" height="520"></canvas>
  </div>
</div>

  <footer>ESP32 · Ultrasonic Sensors · MQTT (HiveMQ Cloud) · WebSockets</footer>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <script>
    // 1) HiveMQ Cloud settings
    const HOST = "YOUR_MQTT_HOST";
const USERNAME = "YOUR_USERNAME";
const PASSWORD = "YOUR_PASSWORD";

    // WebSocket Secure (HiveMQ Cloud): wss://<cluster>:8884/mqtt
    const WS_URL = `wss://${HOST}:8884/mqtt`;

    // 2) Topics (from ESP32 code)
    const TOPIC_LEFT = "sensor/left";
    const TOPIC_RIGHT = "sensor/right";
    const TOPIC_DIRECTION = "Direction";
    const TOPIC_START = "StartSensor";

    // UI references
    const statusEl = document.getElementById("status");
    const dotEl = document.getElementById("dot");
    const brokerLabelEl = document.getElementById("BrokerLabel");

    const dLEl = document.getElementById("dL");
    const dREl = document.getElementById("dR");
    const tLEl = document.getElementById("tL");
    const tREl = document.getElementById("tR");

    const gestureTextEl = document.getElementById("GestureText");
    const startSensorEl = document.getElementById("StartSensor");
    const gestureCountEl = document.getElementById("GestureCount");
    const gestureTimeEl = document.getElementById("GestureTime");

    const logEl = document.getElementById("log");
    const clockEl = document.getElementById("clock");
    const lastMsgTimeEl = document.getElementById("lastMsgTime");

    brokerLabelEl.textContent = `${HOST} (wss:8884/mqtt)`;

    function nowStr(){ return new Date().toLocaleTimeString(); }
    function nowFull(){ return new Date().toLocaleString(); }

    // Update the clock every 0.5 seconds
    setInterval(() => { clockEl.textContent = nowFull(); }, 500);

    // Status Before MQTT messages arrive
    function log(msg){
      const line = `${nowStr()}  ${msg}\n`;
      if (logEl.textContent.startsWith("Waiting for MQTT messages")) logEl.textContent = line;
      else logEl.textContent = line + logEl.textContent;
    }

    function prettyGesture(s){
      // Map raw gesture strings from ESP to nicer display versions 
      const map = {
        "Left to Right": "Left → Right",
        "Right to Left": "Right → Left",
        "Left Sensor UP": "Left Up",
        "Left Sensor DOWN": "Left Down",
        "Right Sensor UP": "Right Up",
        "Right Sensor DOWN": "Right Down",
      };
      return map[s] || s || "—";
    }

    let gestureCount = 0;

    // MQTT.js connect inside the browser using WebSocket and connect to HiveMQ Cloud 
    const client = mqtt.connect(WS_URL, {
      username: USERNAME,
      password: PASSWORD,
      clientId: "web_" + Math.random().toString(16).slice(2),
      reconnectPeriod: 1000,
      clean: true,
      connectTimeout: 8000
    });

    client.on("connect", () => {
      statusEl.textContent = "Connected";
      dotEl.classList.add("connected");
      dotEl.classList.remove("warn");
      logEl.textContent = "";
      log("Connected (WebSocket MQTT)");

      // Subscribe to the topics for sensors and gestures
      client.subscribe([TOPIC_LEFT, TOPIC_RIGHT, TOPIC_DIRECTION, TOPIC_START], (err) => {
        if (err) log("Subscribe error: " + (err?.message || err));
        else log("Subscribed: sensor/left, sensor/right, Direction, StartSensor");
      });
    });

    client.on("reconnect", () => {
      statusEl.textContent = "Reconnecting…";
      dotEl.classList.remove("connected");
      dotEl.classList.add("warn");
    });

    client.on("close", () => {
      statusEl.textContent = "disconnected";
      dotEl.classList.remove("connected");
      dotEl.classList.remove("warn");
    });

    client.on("error", (e) => {
      // show the real error message
      log("MQTT error: " + (e?.message || e));
    });

    // ESP32 > HiveMQ > Browser > client.on("message")
    client.on("message", (topic, payload) => {
      const raw = payload.toString();
      lastMsgTimeEl.textContent = nowStr();

      if (topic === TOPIC_LEFT){
        const v = Number(raw);
        if (!Number.isNaN(v) && v >= 0) dLEl.textContent = raw;
        else dLEl.textContent = "—";
        tLEl.textContent = nowStr();
      }

      if (topic === TOPIC_RIGHT){
        const v = Number(raw);
        if (!Number.isNaN(v) && v >= 0) dREl.textContent = raw;
        else dREl.textContent = "—";
        tREl.textContent = nowStr();
      }

      if (topic === TOPIC_START){
        startSensorEl.textContent = raw;
      }

      if (topic === TOPIC_DIRECTION){
        gestureTextEl.textContent = prettyGesture(raw);
        gestureCount++;
        gestureCountEl.textContent = String(gestureCount);
        gestureTimeEl.textContent = nowStr();
      }

      log(`${topic} → ${raw}`);
      
      // Data is given to the system for the sonar
      if (topic === "sensor/left")  setDistanceLeft(Number(raw));
      if (topic === "sensor/right") setDistanceRight(Number(raw));

    });
  </script>

  
  <script>
    // Sonar visualization script
    let angle = 0;
    let leftDist = null;
    let rightDist = null;
    const MAX_CM = 200;

    function setDistanceLeft(cm){ leftDist = cm; }
    function setDistanceRight(cm){ rightDist = cm; }

    const sonarCanvas = document.getElementById("sonar");
    const sonarCtx = sonarCanvas.getContext("2d");

    function drawSonar() {
      const w = sonarCanvas.width, h = sonarCanvas.height;
      const cx = w/2, cy = h/2;
      const R = Math.min(w, h) * 0.43;

      // Fade for trail
      sonarCtx.fillStyle = "rgba(2, 6, 23, 0.22)";
      sonarCtx.fillRect(0, 0, w, h);

      // Grid
      sonarCtx.strokeStyle = "rgba(34,197,94,0.18)";
      sonarCtx.lineWidth = 1;
      for (let i=1; i<=4; i++){
        sonarCtx.beginPath();
        sonarCtx.arc(cx, cy, (R*i)/4, 0, Math.PI*2);
        sonarCtx.stroke();
      }
      sonarCtx.beginPath(); sonarCtx.moveTo(cx-R, cy); sonarCtx.lineTo(cx+R, cy); sonarCtx.stroke();
      sonarCtx.beginPath(); sonarCtx.moveTo(cx, cy-R); sonarCtx.lineTo(cx, cy+R); sonarCtx.stroke();

      // Sweep
      angle += 0.03;
      const sx = cx + Math.cos(angle) * R;
      const sy = cy + Math.sin(angle) * R;

      sonarCtx.strokeStyle = "rgba(34,197,94,0.9)";
      sonarCtx.lineWidth = 2;
      sonarCtx.beginPath();
      sonarCtx.moveTo(cx, cy);
      sonarCtx.lineTo(sx, sy);
      sonarCtx.stroke();

      // Cone glow
      const grad = sonarCtx.createRadialGradient(cx, cy, 0, cx, cy, R);
      grad.addColorStop(0, "rgba(34,197,94,0.08)");
      grad.addColorStop(1, "rgba(34,197,94,0)");
      sonarCtx.fillStyle = grad;
      sonarCtx.beginPath();
      sonarCtx.arc(cx, cy, R, angle-0.35, angle+0.35);
      sonarCtx.lineTo(cx, cy);
      sonarCtx.fill();

      drawBlip(leftDist, -35 * Math.PI/180);
      drawBlip(rightDist,  35 * Math.PI/180);

      requestAnimationFrame(drawSonar);
    }

    function drawBlip(cm, bearingRad){
      if (cm === null || Number.isNaN(cm) || cm < 0) return;
      const cx = sonarCanvas.width/2, cy = sonarCanvas.height/2;
      const R = Math.min(sonarCanvas.width, sonarCanvas.height) * 0.43;

      const clamped = Math.max(0, Math.min(MAX_CM, cm));
      const rr = (clamped / MAX_CM) * R;

      const x = cx + Math.cos(bearingRad) * rr;
      const y = cy + Math.sin(bearingRad) * rr;

      sonarCtx.fillStyle = "rgba(34,197,94,0.95)";
      sonarCtx.beginPath();
      sonarCtx.arc(x, y, 4, 0, Math.PI*2);
      sonarCtx.fill();

      sonarCtx.fillStyle = "rgba(34,197,94,0.25)";
      sonarCtx.beginPath();
      sonarCtx.arc(x, y, 12, 0, Math.PI*2);
      sonarCtx.fill();
    }
    drawSonar();
</script>
</body>
</html>
